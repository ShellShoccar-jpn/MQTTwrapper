<!doctype html>
<!--
######################################################################
#
# MESSAGEBOARD.HTML:
#     A Japanese Nostalgic Message Board (MQTT via HTTP/2 Demo)
#
# +--- <<Mess up the board with command via MQTT and HTTP/2>> --------
# |
# | This "messageboard.html" becomes an MQTT subscriber and receives
# | some kinds of commands via MQTT to update messages on the board.
# |
# | You may freely rewrite the content of the board. So, publish a lot
# | of commands from your UNIX terminal to rewrite the message and mess
# | up the message board!
# |
# +-------------------------------------------------------------------
#
#
# Written by Shell-Shoccar Japan (@shellshoccarjpn) on 2025-09-24
#
# This is a public-domain software (CC0). It means that all of the
# people can use this for any purposes with no restrictions at all.
# By the way, We are fed up with the side effects which are brought
# about by the major licenses.
#
######################################################################
-->
<html>
<head>
  <meta charset="utf-8">
  <title>Japanese Nostalgic Message Board (MQTT via HTTP/2 Demo)</title>
  <!-- Style for the message board -->
  <style>
  #tablecontainer { background      : #15471D;
                    width           : 640px;
                    margin          : 0;
                    padding         : 5px;               }
  #msgboardtitle  { 
                    margin          : 0;
                    text-align      : center;
                    color           : white;
                    font-size       : xx-large;
                  }
  table.dengonban { border          : 0
                    padding         : 0
                    border-spacing  : 0
                    width           : 100%;
                    table-layout    : fixed;
                    border-collapse : collapse;
                    text-align      : center;
                    vertical-align  : middle;
                    color           : white;
                    overflow        : hidden;            }
  .posmark        { color           : #ffc0c0;
                    font-size       : smaller;           }
  .coltitle       { font-size       : x-large;
                    font-family     : "Yu Gothic";
                    border          : 1px solid white;   }
  .msgbody        { font-size       : normal;
                    border          : 1px solid white;   }
  .warning        { font-size       : small;
                    border-top      : 1px solid white;
                    border-right    : none;
                    border-bottom   : none;
                    border-left     : none;              }
  .bodyrow        { height          : 2.5em;             }
  </style>
  <!-- /Style for the message board -->
</head>

<body>
  <h1>Japanese Nostalgic Message Board (MQTT via HTTP/2 Demo)</h1>
  <p><a href="index.html">Go back to example list</a> / <a href="https://github.com/ShellShoccar-jpn/MQTTwrapper/">Go to the repository of this example on GitHub</a></p>

  <h2>HOST (Where is the broker):</h2>
  <div>
    <dl>
      <dt>URL:</dt>
      <dd>
        <select id="prot"><option>mqtt</option><option>mqtts</option></select>://<input type="text" id="addr" value="" size="20" />:<input type="text" id="port" value="" size="5" />/
      </dd>
      <dd>
        ⇧<br/>Preset ... <select id="preset_selector" onchange="Preset(this.selectedIndex)"><option value="-">(When you select one of them, I will set its URL to the above)</option></select>
      </dd>
    </dl>
  </div>

  <h2>SEND (Behave as a publisher):</h2>
  <div>
    topic = <input type="text" id="sendtopic" value="" size="20" /><br/>
    <textarea id="sendbox"  style="width:40em; height:calc(1.3em*3); line-height:1.3;"></textarea><br/>
    <input type="button" id="publishbutton" value="Publish" onclick="Publish()" />
  </div>

  <h2>RECV (Behave as a subscriber):</h2>
  <div>
    topic = <input type="text" id="recvtopic" value="" size="20" /><br/>
    <textarea id="recvbox"  style="width:40em; height:calc(1.3em*5); line-height:1.3;" readonly="readonly"></textarea><br/>
    <input type="button" id="recvstart" value="Start"  style="width:11em" onclick="StartSub()" />
    <input type="button" id="recvstop"  value="Stop"   style="width:11em" onclick="StopSub()"  />
    <input type="button" id="recvclear" value="Clear"  style="width: 7em" onclick="ClearSub()" />
  </div>

  <h2>Message Board (Pick up from the subscriber):</h3>
  <div id="tablecontainer">
    <h3 id="msgboardtitle">伝言板</h3>
    <table class="dengonban">
      <tr>
        <td class="posmark" style='width:15px' >&nbsp;</td>
        <td class="posmark" style='width:75px' >a</td>
        <td class="posmark" style='width:75px' >b</td>
        <td class="posmark" style='width:460px'>c</td>
      </tr>
      <tr>
        <td class="posmark">1</td>
        <th id="a1" class="coltitle">月日</td>
        <th id="b1" class="coltitle" style='border-left:none'>時分</td>
        <th id="c1" class="coltitle" style='border-left:none'>ご用件</td>
      </tr>
      <tr>
        <td class="posmark">2</td>
        <td id="a2" class="msgbody bodyrow" style='border-top:none'>5/19</td>
        <td id="b2" class="msgbody bodyrow" style='border-top:none;border-left:none'>11:10</td>
        <td id="c2" class="msgbody bodyrow" style='border-top:none;border-left:none'>西新橋には先に行ってるね。by RM</td>
      </tr>
      <tr>
        <td class="posmark">3</td>
        <td id="a3" class="msgbody bodyrow" style='border-top:none'>&nbsp;</td>
        <td id="b3" class="msgbody bodyrow" style='border-top:none;border-left:none'>&nbsp;</td>
        <td id="c3" class="msgbody bodyrow" style='border-top:none;border-left:none'>&nbsp;</td>
      </tr>
      <tr>
        <td class="posmark">4</td>
        <td id="a4" class="msgbody bodyrow" style='border-top:none'>&nbsp;</td>
        <td id="b4" class="msgbody bodyrow" style='border-top:none;border-left:none'>&nbsp;</td>
        <td id="c4" class="msgbody bodyrow" style='border-top:none;border-left:none'>&nbsp;</td>
      </tr>
      <tr>
        <td class="posmark">5</td>
        <td id="a5" class="msgbody bodyrow" style='border-top:none'>&nbsp;</td>
        <td id="b5" class="msgbody bodyrow" style='border-top:none;border-left:none'>&nbsp;</td>
        <td id="c5" class="msgbody bodyrow" style='border-top:none;border-left:none'>&nbsp;</td>
      </tr>
      <tr>
        <td>&nbsp;</td>
        <td colspan="3" class="warning">3日過ぎたものは消します。</td>
      </tr>
    </table>
  </div>
  <p>
    This HTML program (re)writes the message into the message board after the above subscriber has received the following command.
  </p>
  <blockquote style="background-color: lightgray; width: 15em; padding: 0.25em;">write <i>xy</i> <i>msg</i></blockquote>
  <dl>
    <dt><i>x</i></dt><dd>Column Code: For instance, "<code>a</code>" means the date column because the column is at the leftmost and has the code "a." <strong>You have to specify with a row number in practice</strong>, like that "<code>a1</code>."</dd>
    <dt><i>y</i></dt><dd>Row Number: For instance, "<code>1</code>" means the head line of the table because the head line is numbered one. <strong>You have to specify with a column code in practice</strong>, like that "<code>a1</code>."</dd>
    <dt><i>msg</i></dt><dd>Message Text: You can contain space characters in the body of the text. And if you omit the whole part of the message text, the content in the corresponding cell will be erased.</dd>
  </dl>

  <script src="mqttbrokers.js"></script>
  <script type="text/javascript">
    //////////////////////////////////////////////////////////////////
    // Initialize for this webpage
    //////////////////////////////////////////////////////////////////
    const sPubtopic = 'mwexample/msgboard';
    const sSubtopic = 'mwexample/msgboard';
    let oSse;
    (function(){
      let eSel,eOpt,i;
      eSel = document.getElementById('preset_selector');
      if (! eSel                     ) {return;}
      if (typeof oPreset !== 'object') {return;}
      for (i=0; i<oPreset.length; i++) {
        eOpt = document.createElement('option');
        eOpt.value     = oPreset[i].label                                ;
        eOpt.innerHTML = oPreset[i].label + ' &mdash; ' + oPreset[i].desc;
        eSel.appendChild(eOpt);
      }
    })();

    //////////////////////////////////////////////////////////////////
    // Initialize
    //////////////////////////////////////////////////////////////////
    let ePreset        = document.getElementById('preset_selector'     );
    let ePub           = document.getElementById('publishbutton'       );
    let eProt          = document.getElementById('prot'                );
    let eAddr          = document.getElementById('addr'                );
    let ePort          = document.getElementById('port'                );
    let eSendbox       = document.getElementById('sendbox'             );
    let eSendtopic     = document.getElementById('sendtopic'           );
    let eRecvbox       = document.getElementById('recvbox'             );
    let eRecvtopic     = document.getElementById('recvtopic'           );
    let eRecvstart     = document.getElementById('recvstart'           );
    let eRecvstop      = document.getElementById('recvstop'            );
    let eRecvclear     = document.getElementById('recvclear'           );
    
    Preset(1);
    
    
    //////////////////////////////////////////////////////////////////
    //
    // Parse and inject the incoming data into the table
    // the data format assumed the following:
    //   * space-separated-data
    //   * three columns
    //     1 : "write" keyword
    //     2 : positon (e.g. "a1")
    //    [3]: message string
    function parsinjector(sInData) {
      // Parse
      let lsInData, sPos, sMsg, s, e;
      if (typeof sInData !== 'string') {return;}
      sInData = sInData.replace(/\n.*$/,'');
      if (! sInData.match(/^write +[A-Za-z][0-9]( +[^ ].*)?$/)) {return;}
      s    = sInData.replace(/^write +/,'');
      sPos = s.replace(/ .*$/,'').toLowerCase();
      s    = s.replace(/^[^ ]+/,'');
      sMsg = s.replace(/^[^ ]+ +/,'').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/[']/g,'&lsquo;')                   ;
      
      // Write
      e = document.getElementById(sPos);
      if (! e) {return}
      e.innerHTML = sMsg;
    }
    
    
    //////////////////////////////////////////////////////////////////
    // Button Attached Functions
    //////////////////////////////////////////////////////////////////
    
    async function Publish() {
      let msg = eSendbox.value;
      if (msg === '') {
        alert('An empty message is not allowed!');
        return false;
      }

      ePub.disabled       = true;
      eSendtopic.readOnly = true;

      const oCgivars = new URLSearchParams();
      oCgivars.append('host' , eAddr.value);
      oCgivars.append('port' , ePort.value);
      oCgivars.append('topic', eSendtopic.value);
      oCgivars.append('text' , msg);

      try {
        const oRes = await fetch('../cgi/mqtt_via_http_up.cgi', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: oCgivars.toString()
        });
        //
        if (!oRes.ok) {
          let sErr = await oRes.text();
          sErr = JSON.stringify(sErr);
          throw new Error(`{"code":${oRes.status},"message":${sErr}}`);
        }
        //
        const sRes = await oRes.text();
        let o;
        try {
          o = JSON.parse(sRes);
        } catch {
          throw new Error('{"code":500,"message":"Bad response-data"}');
        }

        if (typeof o.status !== 'number') {
          throw new Error('{"code":500,"message":"no status in"}');
        }
        if (o.status > 0) {
          throw new Error(`{"code":500,"message":"(${o.status}) ${o.text || ''}"}`);
        }
        //
        ePub.disabled       = false;
        eSendtopic.readOnly = false;
        return true;
      } catch (oErr) {
        let o;
        try {
          o = JSON.parse(oErr.message);
        } catch {
          o = {code: 400, message: 'unexpected error'};
        }
        alert(`Error happened; (${o.code})\n${o.message}`);
        ePub.disabled       = false;
        eSendtopic.readOnly = false;
        return false;
      }
    }
    
    function Receiver(sMessage) {
      eRecvbox.value     += ((eRecvbox.value!='')?'\n':'') + sMessage;
      eRecvbox.scrollTop  = eRecvbox.scrollHeight;
      parsinjector(sMessage+'');
    }
    
    function StartSub() {
      oSse = new EventSource(
        '../cgi/mqtt_via_http_down.cgi'                  +
        "?host="  + encodeURIComponent(eAddr.value)      +
        "&port="  + encodeURIComponent(ePort.value)      +
        "&topic=" + encodeURIComponent(eRecvtopic.value)
      );
      //
      eProt.item(1-eProt.selectedIndex).disabled = true;
      eAddr.readOnly                             = true;
      ePort.readOnly                             = true;
      ePreset.disabled                           = true;
      eRecvtopic.readOnly                        = true;
      eRecvstart.disabled                        = true;
      eRecvstart.value                           = 'Connecting...';
      //
      oSse.onopen = (o) => {
        eRecvstart.value    = 'NOW SUBSCRIBING';
      }
      //
      oSse.onmessage = (oRet) => {
        let o,s;
        try       {o = JSON.parse(oRet.data);                                }
        catch (e) {console.error('Invalid data field was received.'); return;}
        if (!('status' in o) || (typeof o.status !== 'number')) {
          console.error('Invalid data format in data field.');
          return;
        }
        if ('text' in o) {
          s = o.text;
        } else           {
          console.error('data field does not have "text" property.');
          s = '';
        }
        if (o.status !== 0) {
          console.error(
            'Server returned non-zero status: ('
              + o.status
              + ')'
              + ('text' in o) ? o.text : ''
          );
          StopSub();
          return;
        }
        Receiver(s);
      }
      //
      oSse.onerror = (oRet) => {
        if (oSse.readyState === EventSource.CONNECTING) {
          console.log('Retry to connect...');
          eRecvstart.value = 'Reconnecting...';
          return;
        }
        if (oSse.readyState === EventSource.OPEN      ) {
          console.log('Connecting...');
          return;
        }
        if (oSse.readyState === EventSource.CLOSED    ) {
          console.log('Disconnected');
          StopSub();
          return;
        }
        console.error('Unknown "readyState." Stop subscribe.');
        StopSub();
        return;
      }
    }
    
    function StopSub() {
      if (typeof oSse !== 'object') {return;}
      oSse.close();
      oSse = undefined;
      eProt.item(1-eProt.selectedIndex).disabled = false;
      eAddr.readOnly                             = false;
      ePort.readOnly                             = false;
      ePreset.disabled                           = false;
      eRecvtopic.readOnly                        = false;
      eRecvstart.disabled                        = false;
      eRecvstart.value                           = 'Start';
    }
    
    function ClearSub() {
      eRecvbox.value = '';
    }
    
    function Preset(iNum) {
      if ( typeof(oMQTTw)==='undefined'                            ||
          (typeof(oMQTTw)==='object'   &&oMQTTw.bConnected===false)  ) {
        if (iNum==0) {return;}
        eProt.selectedIndex = oPreset[iNum-1].prot;
        eAddr.value         = oPreset[iNum-1].host;
        ePort.value         = oPreset[iNum-1].port;
        eSendtopic.value    = sPubtopic                            ;
        eRecvtopic.value    = sSubtopic                            ;
      }
      ePreset.selectedIndex = 0;
    }
  </script>


  <h2>README (What is this?):</h3>
  <p>This is a control panel for testing the EventSource class, which is for the "Server-Sent Event (SSE)." This class is helpful for your web browser to work as an MQTT subscriber, as it enables server-push data transmission within HTTP regulations. And HTTP/2 is necessary to make the class truly practical. HTTP/2 can make HTTP data transmission both upstream and downstream more efficiently with a single connection.</strong></p>
  <p>This control panel runs the mosquitto_pub/mosquitto_sub command in a CGI script on the web server by using the EventSource class and the fetch() method. The <a href="https://mosquitto.org/">Mosquitto</a> commands encapsulate/decapsulate MQTT data, instead of the web client, so that this page can work as not only an MQTT subscriber but also an MQTT publisher.</p>
  <p>Try to use me by the following steps.</p>
  
  <h2>How to Use Me:</h2>
  <h3>0-1) [PREP.] Install a HTTP/2 web server</h3>
  <p>Typically, I recommend <a href="https://httpd.apache.org/">Apache</a> or <a href="https://nginx.org/">nginx</a>.<p>
  <ul>
    <li>Requirements for Apache:
      <ul>
        <li>Apache 2.4.17 or later</li>
        <li>Built with <a href="https://www.openssl.org/">OpenSSL</a> 1.0.2 or later</li>
        <li>Built with --enable-ssl, --enable-http2, and --with-mpm=event</li>
        <li>LoadModule mod_ssl, mod_http2, and mod_mpm_event in httpd.conf</li>
        <li>Add "SSLEngine on" and "Protocol h2 http/1.1" in your &lt;VirtualHost&gt; directive</li>
      </ul>
    </li>
    <li>Requirements for nginx:
      <ul>
        <li>nginx 1.9.5 or later</li>
        <li>Built with OpenSSL 1.0.2 or later</li>
        <li>Built with --with-http_ssl_module and --with-http_v2_module</li>
        <li>Add "listen 443 ssl http2" in the server block for your host</li>
      </ul>
    </li>
  </ul>
  <h3>0-2) [PREP.] Install Mosquitto</h3>
  <p>The installation instructions are on <a href="https://mosquitto.org/download/">this page.</a>Then, Copy and save the following text as the file "mosquitto.local.conf" in your favor directory.<br/>
     <textarea style="width:40em; height:calc(1.3em*5); line-height:1.3;" readonly="readonly">allow_anonymous true

#=== Plain MQTT
listener 1883
protocol mqtt</textarea></p>
  <h3>0-3) [PREP.] Git clone this repository into a public web space on your web server</h3>
  <p><textarea style="width:40em; height:1.3em; line-height:1.3;" readonly="readonly">$ https://github.com/ShellShoccar-jpn/MQTTwrapper.git</textarea></p>
  <h3>1) Start an MQTT broker</h3>
  <p>Type the following command on your UNIX terminal.<br/><textarea style="width:40em; height:1.3em; line-height:1.3;" readonly="readonly">$ mosquitto -c mosquitto.local.conf</textarea></p>
  <h3>2) Select the MQTT broker</h3>
  <p>In the "HOST" section, fill in the URL form (Specify "mqtt://localhost:1883/" to use the above MQTT broker, of course, it's OK to use another broker. If you do so, replace "localhost" in the latter explanations with the other host you specified.)</p>
  <h3>3) Start subscribing</h3>
  <p>Move to the "RECV" section. And decide on the MQTT topic name for this trial. Next, type the topic name into the "topicname" field in this section and push the "Start" button in the same section.</p>
  <h3>4) Publish a message rewriting command</h3>
  <p>Publish a message rewriting command on your UNIX terminal with the same topic name and to the same MQTT broker as what you specified in this HTML, like this:<br/><textarea style="width:40em; height:calc(1.3em*2); line-height:1.3;" readonly="readonly">$ echo "write c3 I'll be back soon." | mosquitto_pub -l -h HOSTNAME -t "TOPICNAME"</textarea><br/>Then you can see the message you published on the message board.</p>
  <p>Or you can also publish the same rewriting command from the publisher in the "SEND" section on this HTML.</p>
</body>
</html>
<!--
LICENSES OF THE JAVASCRIPT LIBRARIES
  CC0 or Unlicense
-->
