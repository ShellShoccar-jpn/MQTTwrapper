<!doctype html>
<!--
######################################################################
#
# WHEREAREWEAT.HTML: "Where are we at?" (MQTT via HTTP/2 Demo)
#
# +--- <<Share your location with your friends and record them>> -----
# |
# | This "whereareweat.html" publishes your current location that your
# | web browser senses, subscribes to the locations of your friends,
# | and pins them, of course, yours, too!
# |
# | You can see on the map where your friends and yourself are now
# | with this demo HTML. Moreover, you can record the locations in a
# | text file by another MQTT subscriber working on a UNIX terminal.
# |
# | Try it with your friends!
# +-------------------------------------------------------------------
#
#
# Written by Shell-Shoccar Japan (@shellshoccarjpn) on 2025-09-24
#
# This is a public-domain software (CC0). It means that all of the
# people can use this for any purposes with no restrictions at all.
# By the way, We are fed up with the side effects which are brought
# about by the major licenses.
#
######################################################################
-->
<html>
<head>
  <meta charset="utf-8">
  <title>The Map Worm (MQTT via HTTP/2 Demo)</title>
  <!--  for Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!-- /for Leaflet -->
</head>

<body>
  <h1>The Map Worm (MQTT via HTTP/2 Demo)</h1>
  <p><a href="index.html">Go back to example list</a> / <a href="https://github.com/ShellShoccar-jpn/MQTTwrapper/">Go to the repository of this example on GitHub</a></p>

  <h2>HOST (Where is the broker):</h2>
  <div>
    <dl>
      <dt>URL:</dt>
      <dd>
        <select id="prot"><option>mqtt</option><option>mqtts</option></select>://<input type="text" id="addr" value="" size="20" />:<input type="text" id="port" value="" size="5" />/
      </dd>
      <dd>
        ⇧<br/>Preset ... <select id="preset_selector" onchange="Preset(this.selectedIndex)"><option value="-">(When you select one of them, I will set its URL to the above)</option></select>
      </dd>
    </dl>
  </div>

  <h2>SEND (Behave as a publisher):</h2>
  <div>
    topic = <input type="text" id="sendtopic" value="example/whereareweat" size="20" /><br/>
    myname : <input type="text" id="myname" value="" size="20" /><br/>
    <input type="button" id="publishbutton"  value="Publish my location" onclick="Publish(true)"  />
    <input type="button" id="publishbutton2" value="Erase my location"   onclick="Publish(false)" />
  </div>

  <h2>RECV (Behave as a subscriber):</h2>
  <div>
    topic = <input type="text" id="recvtopic" value="" size="20" /><br/>
    <textarea id="recvbox"  style="width:40em; height:calc(1.3em*5); line-height:1.3;" readonly="readonly"></textarea><br/>
    <input type="button" id="recvstart" value="Start"  style="width:11em" onclick="StartSub()" />
    <input type="button" id="recvstop"  value="Stop"   style="width:11em" onclick="StopSub()"  />
    <input type="button" id="recvclear" value="Clear"  style="width: 7em" onclick="ClearSub()" />
  </div>

  <h2>Map (Pick up from the subscriber):</h3>
  <div>
    <div id="map" style="width:640px;height:480px;"></div>
    <dl><dt>control:</dt>
        <dd><label><input type="checkbox" value="on" id="tracer" checked="checked" />Trace all pins</label></dd>
        <dd><input type="button" value="Erace all pins" onclick="EraseObjectsOnMap()" /></dd>
    </dl>
  </div>
  <p>
    The coordinate points will be pinned and drawn lines when the above subscriber receives them if the coordinate is formatted like the following.
  </p>
  <blockquote style="background-color: lightgray; width: 15em; padding: 0.25em;">plot <i>lat</i> <i>lng</i> <i>name</i></blockquote>
  <dl>
    <dt><i>lat</i></dt><dd>Latitude  (real-number,  -90&#8806;<i>lat</i>&#8806;90)</dd>
    <dt><i>lng</i></dt><dd>Longitude (real-number, -180&#8806;<i>lng</i>&#8806;180)</dd>
    <dt><i>name</i></dt><dd>the name of the point (option)</dd>
  </dl>
  <p>
    Or you can erase your pin by the following message.
  </p>
  <blockquote style="background-color: lightgray; width: 15em; padding: 0.25em;">erase <i>name</i></blockquote>
  <p>
    "<i>name</i>" is the name of your pin. But the word "all" is the special one to erase all pins.
  </p>

  <script src="mqttbrokers.js"></script>
  <script type="text/javascript">
    //////////////////////////////////////////////////////////////////
    // Initialize for this webpage
    //////////////////////////////////////////////////////////////////
    const sPubtopic = 'mwexample/mapworm';
    const sSubtopic = 'mwexample/mapworm';
    let oSse;
    (function(){
      let eSel,eOpt,i;
      eSel = document.getElementById('preset_selector');
      if (! eSel                     ) {return;}
      if (typeof oPreset !== 'object') {return;}
      for (i=0; i<oPreset.length; i++) {
        eOpt = document.createElement('option');
        eOpt.value     = oPreset[i].label                                ;
        eOpt.innerHTML = oPreset[i].label + ' &mdash; ' + oPreset[i].desc;
        eSel.appendChild(eOpt);
      }
    })();

    //////////////////////////////////////////////////////////////////
    // Initialize
    //////////////////////////////////////////////////////////////////
    let ePreset        = document.getElementById('preset_selector'     );
    let ePub           = document.getElementById('publishbutton'       );
    let ePub2          = document.getElementById('publishbutton2'      );
    let eProt          = document.getElementById('prot'                );
    let eAddr          = document.getElementById('addr'                );
    let ePort          = document.getElementById('port'                );
    let eMyname        = document.getElementById('myname'              );
    let eSendtopic     = document.getElementById('sendtopic'           );
    let eRecvbox       = document.getElementById('recvbox'             );
    let eRecvtopic     = document.getElementById('recvtopic'           );
    let eRecvstart     = document.getElementById('recvstart'           );
    let eRecvstop      = document.getElementById('recvstop'            );
    let eRecvclear     = document.getElementById('recvclear'           );
    
    Preset(1);
    
    
    //////////////////////////////////////////////////////////////////
    // Initialize for the Map
    //////////////////////////////////////////////////////////////////
    
    let eTracer = document.getElementById('tracer');
    let oPins = new Array();
    let oLine;
    let oFgrp = L.featureGroup();
    let oMap = L.map('map').setView([35.6889101,139.748428], 11);
    if (true) {
      // --- Google Maps ---
      L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',
                  {attribution: '<a href="https://developers.google.com/maps/documentation" target="_blank">Google Map</a>'})
       .addTo(oMap);
    } else    {
      // --- OpenStreetMap ---
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                  {attribution: 'c <a href="https://osm.org/copyright">OpenStreetMap</a> contributors, <a href="//creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'})
       .addTo(oMap);
    }
    // Parse and inject the incoming data into the chart
    // the data format assumed the following:
    //   * space-separated-data
    //   * three or four columns
    //     1 : "plot" keyword
    //     2 : latitude  ( -90<=lat<= 90)
    //     3 : longitude (-180<=lon<=180)
    //    [4]: pointname
    function parsinjector(sInData) {
      // Parse
      let lsInData, nLat, nLng, sNam, s;
      if (typeof sInData !== 'string') {return;}
      sInData = sInData.replace(/\n.*$/,'');
      if        (sInData.match(/^plot +[+-]?\d+(\.\d+)? +[+-]?\d+(\.\d+)? +[^ ].*?$/)) {
        s    = sInData.replace(/^plot +/,'');
        nLat = s.replace(/ .*$/,'') *1;
        s    = s.replace(/^[^ ]+ +/,'');
        nLng = s.replace(/ .*$/,'') *1;
        sNam = s.replace(/^[^ ]+ */,'');
        
        // Plot
        if (sNam in oPins) {oPins[sNam].remove();oFgrp.removeLayer(oPins[sNam]);delete oPins[sNam];}
        oPins[sNam] = L.marker([nLat, nLng]).addTo(oMap);
        oPins[sNam].bindPopup(sNam).openPopup();
        oFgrp.addLayer(oPins[sNam]);
        // Fit the screen
        if (eTracer.checked) {oMap.fitBounds(oFgrp.getBounds());}
      } else if (sInData.match(/^erase +all$/)                                   ) {
        EraseObjectsOnMap();
      } else if (sInData.match(/^erase +[^ ].*?$/)                               ) {
        sNam = sInData.replace(/^erase +/,'');
        if (sNam in oPins) {oPins[sNam].remove();oFgrp.removeLayer(oPins[sNam]);delete oPins[sNam];}
      }
    }
    
    
    //////////////////////////////////////////////////////////////////
    // Button Attached Functions
    //////////////////////////////////////////////////////////////////
    
    async function Publish(b) {
      let msg;
      let sName = eMyname.value;
      if (sName.match(/^ *$/)) {alert('Mr. Nobody, may I have your real name?'             ); return false;}
      if (sName === 'all'    ) {alert('Sorry, the name "all" is reserved. Set another one.'); return false;}

      if (b) {
        const oLoc = await new Promise(
                       (resolve, reject)=>{
                         navigator.geolocation.getCurrentPosition(resolve, reject);
                       }
                     ).catch(
                       (error) => {
                         switch (error.code) {
                           case error.PERMISSION_DENIED:
                             if (location.protocol === 'http:') {
                               alert('Your web browser refused to give your location to this program.\nMost web browsers always refuse it on non-HTTPS web page.');
                             } else {
                               alert('Your web browser refused to give your location to this program.\nAllow your web browser to give the location.');
                             }
                             break;
                           default:
                             alert('Error happend while getting your location.');
                             break;
                         }
                       }
                     );
        if (! oLoc) {return false;}
        msg='plot '+oLoc.coords.latitude+' '+oLoc.coords.longitude+' '+eMyname.value;
      } else   {
        msg='erase '+eMyname.value;
      }

      ePub.disabled       = true;
      eSendtopic.readOnly = true;

      const oCgivars = new URLSearchParams();
      oCgivars.append('host' , eAddr.value);
      oCgivars.append('port' , ePort.value);
      oCgivars.append('topic', eSendtopic.value);
      oCgivars.append('text' , msg);

      try {
        const oRes = await fetch('../cgi/mqtt_via_http_up.cgi', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: oCgivars.toString()
        });
        //
        if (!oRes.ok) {
          let sErr = await oRes.text();
          sErr = JSON.stringify(sErr);
          throw new Error(`{"code":${oRes.status},"message":${sErr}}`);
        }
        //
        const sRes = await oRes.text();
        let o;
        try {
          o = JSON.parse(sRes);
        } catch {
          throw new Error('{"code":500,"message":"Bad response-data"}');
        }

        if (typeof o.status !== 'number') {
          throw new Error('{"code":500,"message":"no status in"}');
        }
        if (o.status > 0) {
          throw new Error(`{"code":500,"message":"(${o.status}) ${o.text || ''}"}`);
        }
        //
        ePub.disabled       = false;
        eSendtopic.readOnly = false;
        return true;
      } catch (oErr) {
        let o;
        try {
          o = JSON.parse(oErr.message);
        } catch {
          o = {code: 400, message: 'unexpected error'};
        }
        alert(`Error happened; (${o.code})\n${o.message}`);
        ePub.disabled       = false;
        eSendtopic.readOnly = false;
        return false;
      }
    }
    
    function Receiver(sMessage) {
      eRecvbox.value     += ((eRecvbox.value!='')?'\n':'') + sMessage;
      eRecvbox.scrollTop  = eRecvbox.scrollHeight;
      parsinjector(sMessage+'');
    }
    
    function StartSub() {
      oSse = new EventSource(
        '../cgi/mqtt_via_http_down.cgi'                  +
        "?host="  + encodeURIComponent(eAddr.value)      +
        "&port="  + encodeURIComponent(ePort.value)      +
        "&topic=" + encodeURIComponent(eRecvtopic.value)
      );
      //
      eProt.item(1-eProt.selectedIndex).disabled = true;
      eAddr.readOnly                             = true;
      ePort.readOnly                             = true;
      ePreset.disabled                           = true;
      eRecvtopic.readOnly                        = true;
      eRecvstart.disabled                        = true;
      eRecvstart.value                           = 'Connecting...';
      //
      oSse.onopen = (o) => {
        eRecvstart.value    = 'NOW SUBSCRIBING';
      }
      //
      oSse.onmessage = (oRet) => {
        let o,s;
        try       {o = JSON.parse(oRet.data);                                }
        catch (e) {console.error('Invalid data field was received.'); return;}
        if (!('status' in o) || (typeof o.status !== 'number')) {
          console.error('Invalid data format in data field.');
          return;
        }
        if ('text' in o) {
          s = o.text;
        } else           {
          console.error('data field does not have "text" property.');
          s = '';
        }
        if (o.status !== 0) {
          console.error(
            'Server returned non-zero status: ('
              + o.status
              + ')'
              + ('text' in o) ? o.text : ''
          );
          StopSub();
          return;
        }
        Receiver(s);
      }
      //
      oSse.onerror = (oRet) => {
        if (oSse.readyState === EventSource.CONNECTING) {
          console.log('Retry to connect...');
          eRecvstart.value = 'Reconnecting...';
          return;
        }
        if (oSse.readyState === EventSource.OPEN      ) {
          console.log('Connecting...');
          return;
        }
        if (oSse.readyState === EventSource.CLOSED    ) {
          console.log('Disconnected');
          StopSub();
          return;
        }
        console.error('Unknown "readyState." Stop subscribe.');
        StopSub();
        return;
      }
    }
    
    function StopSub() {
      if (typeof oSse !== 'object') {return;}
      oSse.close();
      oSse = undefined;
      eProt.item(1-eProt.selectedIndex).disabled = false;
      eAddr.readOnly                             = false;
      ePort.readOnly                             = false;
      ePreset.disabled                           = false;
      eRecvtopic.readOnly                        = false;
      eRecvstart.disabled                        = false;
      eRecvstart.value                           = 'Start';
    }
    
    function ClearSub() {
      eRecvbox.value = '';
    }
    
    function Preset(iNum) {
      if ( typeof(oMQTTw)==='undefined'                            ||
          (typeof(oMQTTw)==='object'   &&oMQTTw.bConnected===false)  ) {
        if (iNum==0) {return;}
        eProt.selectedIndex = oPreset[iNum-1].prot;
        eAddr.value         = oPreset[iNum-1].host;
        ePort.value         = oPreset[iNum-1].port;
        eSendtopic.value    = sPubtopic                            ;
        eRecvtopic.value    = sSubtopic                            ;
      }
      ePreset.selectedIndex = 0;
    }
    
    function EraseObjectsOnMap() {
      oPins.forEach((oPin)=>{oPin.remove();oFgrp.removeLayer(oPin);});
      oPins={};
      oFgrp.remove();
      oFgrep=null; oFgrep = L.featureGroup();
    }
  </script>


  <h2>README (What is this?):</h3>
  <p>This is a control panel for testing the EventSource class, which is for the "Server-Sent Event (SSE)." This class is helpful for your web browser to work as an MQTT subscriber, as it enables server-push data transmission within HTTP regulations. And HTTP/2 is necessary to make the class truly practical. HTTP/2 can make HTTP data transmission both upstream and downstream more efficiently with a single connection.</strong></p>
  <p>This control panel runs the mosquitto_pub/mosquitto_sub command in a CGI script on the web server by using the EventSource class and the fetch() method. The <a href="https://mosquitto.org/">Mosquitto</a> commands encapsulate/decapsulate MQTT data, instead of the web client, so that this page can work as not only an MQTT subscriber but also an MQTT publisher.</p>
  <p>Try to use me by the following steps.</p>
  
  <h2>How to Use Me:</h2>
  <h3>0-1) [PREP.] Install a HTTP/2 web server</h3>
  <p>Typically, I recommend <a href="https://httpd.apache.org/">Apache</a> or <a href="https://nginx.org/">nginx</a>.<p>
  <ul>
    <li>Requirements for Apache:
      <ul>
        <li>Apache 2.4.17 or later</li>
        <li>Built with <a href="https://www.openssl.org/">OpenSSL</a> 1.0.2 or later</li>
        <li>Built with --enable-ssl, --enable-http2, and --with-mpm=event</li>
        <li>LoadModule mod_ssl, mod_http2, and mod_mpm_event in httpd.conf</li>
        <li>Add "SSLEngine on" and "Protocol h2 http/1.1" in your &lt;VirtualHost&gt; directive</li>
      </ul>
    </li>
    <li>Requirements for nginx:
      <ul>
        <li>nginx 1.9.5 or later</li>
        <li>Built with OpenSSL 1.0.2 or later</li>
        <li>Built with --with-http_ssl_module and --with-http_v2_module</li>
        <li>Add "listen 443 ssl http2" in the server block for your host</li>
      </ul>
    </li>
  </ul>
  <h3>0-2) [PREP.] Install Mosquitto</h3>
  <p>The installation instructions are on <a href="https://mosquitto.org/download/">this page.</a>Then, Copy and save the following text as the file "mosquitto.local.conf" in your favor directory.<br/>
     <textarea style="width:40em; height:calc(1.3em*5); line-height:1.3;" readonly="readonly">allow_anonymous true

#=== Plain MQTT
listener 1883
protocol mqtt</textarea></p>
  <h3>0-3) [PREP.] Git clone this repository into a public web space on your web server</h3>
  <p><textarea style="width:40em; height:1.3em; line-height:1.3;" readonly="readonly">$ https://github.com/ShellShoccar-jpn/MQTTwrapper.git</textarea></p>
  <h3>1) Start an MQTT broker</h3>
  <p>Type the following command on your UNIX terminal.<br/><textarea style="width:40em; height:1.3em; line-height:1.3;" readonly="readonly">$ mosquitto -c mosquitto.local.conf</textarea></p>
  <h3>2) Select the MQTT broker</h3>
  <p>In the "HOST" section, fill in the URL form (Specify "mqtt://localhost:1883/" to use the above MQTT broker, of course, it's OK to use another broker. If you do so, replace "localhost" in the latter explanations with the other host you specified.)</p>
  <h3>3) Start subscribing</h3>
  <p>Move to the "RECV" section. And decide on the MQTT topic name for this trial. Next, type the topic name into the "topicname" field in this section and push the "Start" button in the same section.</p>
  <h3>4) Publish your location</h3>
  <p>Write the same topic name as the one in the "RECV" section. Next, decide on the name of your pin and type it into the "myname" field. Finally, push the "Publish my location" button in the same section. Then you can see your pin on the map.</p>
  <p>Or you can also publish the same plotting command from the publisher in the "SEND" section on this HTML. See the "Map" section for the command usage.</p>
</body>
</html>
<!--
LICENSES OF THE JAVASCRIPT LIBRARIES
  This file:
    CC0 or Unlicense
  Leaflet:
    Copyright © 2010–2023 Volodymyr Agafonkin.
    Released under the BSD 2-clause license https://opensource.org/license/bsd-2-clause/
-->
